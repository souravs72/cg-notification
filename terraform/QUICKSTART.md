# Quick Start Guide

## Before You Begin

1. **AWS CLI configured**: `aws configure`
2. **Terraform installed**: `terraform version` (>= 1.0)
3. **Copy example variables**: `cp terraform.tfvars.example terraform.tfvars`
4. **Edit terraform.tfvars**: Update `s3_bucket_name` with a globally unique name

## Deploy Infrastructure

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

## After Deployment

### 1. Update Secrets in AWS Secrets Manager

**Important**: The database password is auto-generated by Terraform and stored in Secrets Manager. **Do NOT manually update it** - RDS will not sync password changes automatically.

Update the following secrets (db-password is managed by Terraform):

```bash
# Get secret ARNs from outputs or AWS Console
aws secretsmanager update-secret \
  --secret-id cg-notification/sendgrid-api-key \
  --secret-string "SG.your-sendgrid-key"

aws secretsmanager update-secret \
  --secret-id cg-notification/wasender-api-key \
  --secret-string "your-wasender-key"

aws secretsmanager update-secret \
  --secret-id cg-notification/admin-api-key \
  --secret-string "your-admin-key"
```

### 2. Build and Push Docker Images

```bash
# Get ECR URLs
terraform output ecr_api_repository_url
terraform output ecr_email_worker_repository_url
terraform output ecr_whatsapp_worker_repository_url

# Login to ECR
aws ecr get-login-password --region ap-south-1 | \
  docker login --username AWS --password-stdin <ACCOUNT_ID>.dkr.ecr.ap-south-1.amazonaws.com

# Build and push (from project root)
docker build -f notification-api/Dockerfile -t <ECR_API_URI>:latest .
docker build -f email-worker/Dockerfile -t <ECR_EMAIL_URI>:latest .
docker build -f whatsapp-worker/Dockerfile -t <ECR_WHATSAPP_URI>:latest .

docker push <ECR_API_URI>:latest
docker push <ECR_EMAIL_URI>:latest
docker push <ECR_WHATSAPP_URI>:latest
```

### 3. Force ECS Service Deployment

```bash
CLUSTER="cg-notification-cluster"

aws ecs update-service --cluster $CLUSTER --service notification-api-service --force-new-deployment
aws ecs update-service --cluster $CLUSTER --service email-worker-service --force-new-deployment
aws ecs update-service --cluster $CLUSTER --service whatsapp-worker-service --force-new-deployment
```

### 4. Verify Deployment

```bash
# Check service status
aws ecs describe-services \
  --cluster cg-notification-cluster \
  --services notification-api-service email-worker-service whatsapp-worker-service

# Get ALB DNS name
terraform output alb_dns_name

# Test health endpoint
curl http://$(terraform output -raw alb_dns_name)/actuator/health
```

## Key Outputs

```bash
terraform output
```

Important outputs:
- `alb_dns_name` - API endpoint
- `rds_endpoint` - Database connection
- `msk_bootstrap_brokers` - Kafka bootstrap servers
- `ecr_*_repository_url` - Container registry URLs

## Important Notes

- **NAT Gateway costs**: ~$32/month + data processing
- **RDS password**: Auto-generated by Terraform and stored in Secrets Manager. **Do NOT manually update** - RDS does not auto-sync password changes.
- **ECS tasks**: Run in private subnets (no public IPs)
- **MSK IAM**: Uses `Resource = "*"` for data-plane actions (required for MSK Serverless IAM authentication)
- **Kafka topics**: Auto-created by MSK Serverless (default 1 partition)

## Troubleshooting

See `README.md` for detailed troubleshooting steps.

