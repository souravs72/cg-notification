# Terraform Infrastructure for cg-notification

This Terraform module provisions the complete AWS infrastructure for the cg-notification system.

## Architecture

- **Compute**: ECS Fargate (3 services)
- **Database**: RDS PostgreSQL Multi-AZ
- **Messaging**: MSK Serverless with IAM authentication
- **Load Balancer**: Application Load Balancer (ALB)
- **Secrets**: AWS Secrets Manager
- **Container Registry**: ECR
- **Storage**: S3
- **Networking**: VPC with public + private subnets, NAT Gateway

## Prerequisites

1. AWS CLI configured with appropriate permissions
2. Terraform >= 1.0 installed
3. AWS account with permissions to create:
   - VPC, subnets, NAT Gateway
   - ECS, ECR, RDS, MSK, ALB, S3
   - IAM roles and policies
   - Secrets Manager secrets
   - CloudWatch log groups

## Quick Start

For detailed step-by-step deployment instructions, see **[DEPLOYMENT.md](DEPLOYMENT.md)**.

**Quick deploy (after prerequisites):**
```bash
export AWS_PROFILE=<profile>
export AWS_REGION=ap-south-1
cd terraform
terraform init && terraform plan -out=tfplan && terraform apply tfplan
```

Then follow the post-deployment steps in `DEPLOYMENT.md`: inject secrets → run migrations → create MSK topics → build/push images → force ECS deploy.

**Full automation:**
Use `./scripts/deploy-trigger.sh` from the project root for a complete automated deployment (see `DEPLOYMENT.md` for details).

## Important Notes

### Security

- **ECS tasks run in private subnets** with `assign_public_ip = false`
- **NAT Gateway** is required for outbound internet access (costs ~$32/month)
- **All secrets** are stored in AWS Secrets Manager (not in Terraform state)
- **RDS is not publicly accessible** (only accessible from ECS security group)
- **RDS password** is auto-generated by Terraform. **Do NOT manually update** the secret - RDS does not auto-sync password changes.
- **MSK uses IAM authentication** (SASL/IAM) with explicit cluster/topic/group ARNs

### Cost Considerations

- NAT Gateway: ~$32/month + data processing (~$0.045/GB)
- Consider VPC endpoints for S3/Secrets Manager to reduce NAT Gateway costs
- RDS Multi-AZ doubles compute cost (primary + standby)
- MSK Serverless is pay-per-use

### Scheduled Jobs

The `notification-api` service runs scheduled jobs. With multiple tasks, implement database-based leader election (e.g., PostgreSQL advisory locks) to prevent duplicate execution.

### Kafka Topics

Create `notifications-email` and `notifications-whatsapp` before sending messages. From project root:

```bash
./scripts/create-msk-topics.sh
```

This runs a one-off ECS task (kafka-admin image) that creates the topics on MSK. Requires Docker, AWS CLI, jq, and `terraform output` (run from `terraform/` or set `TERRAFORM_DIR`). If topics already exist, the script is idempotent.

## Outputs

After deployment, use `terraform output` to get:

- `alb_dns_name` - ALB DNS name for API access
- `rds_endpoint` - RDS connection endpoint
- `msk_bootstrap_brokers` - MSK bootstrap servers (SASL/IAM)
- `ecs_cluster_name` - ECS cluster name
- `ecr_*_repository_url` - ECR repository URLs
- `s3_bucket_name` - S3 bucket name

## File Structure

```
terraform/
├── providers.tf          # Provider configuration
├── variables.tf          # Input variables
├── outputs.tf            # Output values
├── vpc.tf                # VPC, subnets, NAT Gateway
├── security-groups.tf    # Security groups
├── rds.tf                # RDS PostgreSQL
├── msk.tf                # MSK Serverless cluster
├── ecr.tf                # ECR repositories
├── iam.tf                # IAM roles and policies
├── secrets.tf            # Secrets Manager secrets
├── s3.tf                 # S3 bucket
├── cloudwatch.tf         # CloudWatch log groups
├── ecs-cluster.tf        # ECS cluster
├── ecs-tasks.tf          # ECS task definitions
├── ecs-services.tf       # ECS services
├── alb.tf                # Application Load Balancer
└── README.md             # This file
```

## Troubleshooting

For detailed troubleshooting steps and common failure modes, see **[DEPLOYMENT.md](DEPLOYMENT.md)** (Troubleshooting section).

Common issues:
- Tasks not starting → Check Secrets Manager access, ECR image pull, health checks
- Database connection issues → Verify RDS Proxy and security groups
- Kafka connection issues → Verify MSK security groups and IAM permissions

## Destroying Infrastructure

⚠️ **Warning**: This will delete all resources including RDS database and S3 bucket.

```bash
terraform destroy
```

Note: RDS final snapshot will be created before deletion (if `skip_final_snapshot = false`).

